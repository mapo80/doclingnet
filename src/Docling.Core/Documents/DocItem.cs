using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using Docling.Core.Geometry;
using Docling.Core.Primitives;

namespace Docling.Core.Documents;

/// <summary>
/// Base type for all document items generated by the pipeline.
/// Mirrors the Python Docling item model featuring id/tags/metadata support.
/// </summary>
public abstract class DocItem
{
    private readonly Dictionary<string, object?> _metadata;
    private readonly SortedSet<string> _tags;
    private readonly List<DocItemProvenance> _provenance;
    private readonly ReadOnlyCollection<DocItemProvenance> _provenanceView;
    private readonly ReadOnlyDictionary<string, object?> _metadataView;

    protected DocItem(
        DocItemKind kind,
        PageReference page,
        BoundingBox box,
        string? id = null,
        IEnumerable<string>? tags = null,
        IReadOnlyDictionary<string, object?>? metadata = null,
        DateTimeOffset? createdAt = null)
    {
        Kind = kind;
        Page = page;
        BoundingBox = box;
        Id = string.IsNullOrWhiteSpace(id) ? GenerateId(kind, page) : id!;
        CreatedAt = createdAt ?? DateTimeOffset.UtcNow;
        _metadata = metadata is null
            ? new Dictionary<string, object?>(StringComparer.OrdinalIgnoreCase)
            : new Dictionary<string, object?>(metadata, StringComparer.OrdinalIgnoreCase);
        _metadataView = new ReadOnlyDictionary<string, object?>(_metadata);
        _tags = new SortedSet<string>(StringComparer.OrdinalIgnoreCase);
        if (tags is not null)
        {
            foreach (var tag in tags)
            {
                AddTag(tag);
            }
        }

        _provenance = new List<DocItemProvenance>();
        _provenanceView = _provenance.AsReadOnly();
    }

    public string Id { get; }

    public DocItemKind Kind { get; }

    public PageReference Page { get; }

    public BoundingBox BoundingBox { get; private set; }

    public DateTimeOffset CreatedAt { get; }

    public IReadOnlyDictionary<string, object?> Metadata => _metadataView;

    public IReadOnlyCollection<string> Tags => _tags;

    public IReadOnlyList<DocItemProvenance> Provenance => _provenanceView;

    public bool HasTag(string tag)
    {
        ArgumentException.ThrowIfNullOrEmpty(tag);
        return _tags.Contains(tag);
    }

    public void AddTag(string tag)
    {
        ArgumentException.ThrowIfNullOrEmpty(tag);
        _tags.Add(tag);
    }

    public bool RemoveTag(string tag)
    {
        ArgumentException.ThrowIfNullOrEmpty(tag);
        return _tags.Remove(tag);
    }

    public bool TryGetMetadata<T>(string key, out T value)
    {
        ArgumentException.ThrowIfNullOrEmpty(key);
        if (_metadata.TryGetValue(key, out var raw) && raw is T casted)
        {
            value = casted;
            return true;
        }

        value = default!;
        return false;
    }

    public void SetProvenance(IEnumerable<DocItemProvenance>? provenance)
    {
        _provenance.Clear();
        if (provenance is not null)
        {
            foreach (var entry in provenance)
            {
                if (entry is null)
                {
                    continue;
                }

                _provenance.Add(entry);
            }
        }

        UpdateProvenanceMetadata();
    }

    public void AddProvenance(DocItemProvenance provenance)
    {
        ArgumentNullException.ThrowIfNull(provenance);
        _provenance.Add(provenance);
        UpdateProvenanceMetadata();
    }

    protected void SetMetadata<T>(string key, T value)
    {
        ArgumentException.ThrowIfNullOrEmpty(key);
        _metadata[key] = value;
    }

    protected void MergeMetadata(IEnumerable<KeyValuePair<string, object?>> metadata)
    {
        ArgumentNullException.ThrowIfNull(metadata);
        foreach (var (key, value) in metadata)
        {
            if (string.IsNullOrWhiteSpace(key))
            {
                continue;
            }

            _metadata[key] = value;
        }
    }

    protected void UpdateBoundingBox(BoundingBox box)
    {
        BoundingBox = box;
    }

    private void UpdateProvenanceMetadata()
    {
        if (_provenance.Count == 0)
        {
            SetMetadata("docling:provenance", Array.Empty<IReadOnlyDictionary<string, object?>>());
            return;
        }

        var serialized = _provenance
            .Select(entry => entry.ToMetadata())
            .ToArray();

        SetMetadata("docling:provenance", serialized);
    }

    private static string GenerateId(DocItemKind kind, PageReference page)
    {
        var prefix = kind.ToString().ToUpperInvariant();
        return $"{prefix}-{page.PageNumber}-{Guid.NewGuid():N}";
    }
}
