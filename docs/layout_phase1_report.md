# Layout Phase 1 – Bitmap Cache Metrics

This document summarises the first optimisation cycle described in `PIANO_INTERVENTO_LAYOUT.md`. The focus of this phase was to
eliminate redundant bitmap decodes performed by the .NET layout pipeline when persisting PNG artefacts for the Heron ONNX
runner.

## Benchmark Configuration

- **Image**: `dataset/2305.03393v1-pg9-img.png`
- **Runs**: 40 iterations, 5 warm-up cycles
- **Scenario**: comparison between the previous implementation (decoding each PNG to inspect its dimensions) and the optimised
  flow (metadata sourced directly from the pipeline payload).

## Results

| Scenario | Mean Persist Cost (ms) |
| --- | ---: |
| Baseline (.NET, per-page decode) | 13.44 |
| Optimised (metadata reuse) | 1.13 |
| **Savings** | **12.31** |

Applying the measured savings to the historical benchmark (Python mean ≈ 434.6 ms, .NET mean ≈ 465.1 ms) yields the following
estimate for the end-to-end layout pipeline after Phase 1:

| Pipeline | Mean runtime (ms) | Δ vs Python (ms) | Ratio (.NET / Python) |
| --- | ---: | ---: | ---: |
| Python (reference) | 434.6 | – | 1.00 |
| .NET (before) | 465.1 | +30.5 | 1.07 |
| .NET (after Phase 1) | **452.79** | **+18.19** | **1.04** |

The optimisation cuts the performance delta by ~40 % (12.31 ms absolute) while preserving functional parity.

## Generated Artefacts

- Raw benchmark output: `results/layout_phase1/bitmap_cache_benchmark.json`
- Derived comparative metrics: `results/layout_phase1/phase1_metrics.json`
- Helper script: `eng/tools/layout_phase1_metrics.py`

These artefacts can be regenerated by running:

```bash
mkdir -p packages/custom  # once per repo clone
DOTNET_ROLL_FORWARD=LatestMajor dotnet run --project tools/LayoutPerfBenchmarks -- dataset/2305.03393v1-pg9-img.png 40
eng/tools/layout_phase1_metrics.py
```

The environment variable is optional but ensures the CLI selects the available runtime when multiple .NET versions are installed.
