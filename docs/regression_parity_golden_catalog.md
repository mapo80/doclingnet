# DLN-043a â€“ Golden regression dataset catalog

## Objectives

DLN-043a defines the authoritative corpus of end-to-end regression fixtures and the structure of the golden bundles generated by the Python Docling CLI. The catalog ensures:

- **Functional coverage** across the main document archetypes handled by the pipeline (scientific articles, forms, tables, figures-only pages, multilingual content).
- **Deterministic golden artefacts** that encode Markdown, asset files, provenance metadata, and telemetry captured from the Python reference implementation.
- **Repeatable refresh criteria** to version and update the goldens when the reference pipeline, ML models, or CLI configuration change.

## Golden bundle layout

Each regression case emits a self-contained directory under `dataset/golden/<version>/<case-id>/` with the following structure:

```
<case-id>/
  source/
    input.pdf|png              # Original input used to generate the goldens.
    notes.md                   # Provenance notes, copyright, and acquisition metadata.
  python-cli/
    docling.md                 # Markdown generated by `docling` Python CLI.
    assets/                    # Cropped images referenced from Markdown.
      *.png
    manifest.json              # Structured manifest with Markdown checksum, asset inventory, and bounding boxes.
    telemetry.json             # Snapshot of CLI options, model versions, and runtime telemetry.
  diffs/
    README.md                  # Placeholder reserved for parity reports generated by DLN-043c.
```

### `manifest.json`

The manifest provides normalized metadata that the .NET comparator can consume without relying on file names. Mandatory fields:

| Field | Type | Description |
| --- | --- | --- |
| `caseId` | string | Matches the catalog identifier (e.g., `DLN043A-001`). |
| `sourceSha256` | string | SHA-256 of the original input to guarantee integrity. |
| `markdownSha256` | string | Hash of `docling.md` for quick drift detection. |
| `assets` | array | Each entry records `fileName`, `widthPx`, `heightPx`, `dpi`, `sha256`, and `boundingBox` relative to the original page. |
| `pages` | array | Per-page metadata: DPI, dimensions, layout polygon checksum, OCR statistics. |
| `generatedAtUtc` | string | ISO-8601 timestamp of golden creation. |
| `pythonCliVersion` | string | Semantic version of the Python CLI tag used to create the artefacts. |
| `models` | object | Map containing `layout`, `ocr`, `tableformer` model identifiers / digests. |

Optional fields cover alternative serializers (HTML, JSON) and debug overlays emitted during golden refreshes.

### `telemetry.json`

Captured via the Python CLI telemetry hook. Contains:

- `commandLine`: Raw CLI arguments used for the run.
- `pipelineOptions`: Normalized options (DPI, preprocessors, toggles).
- `executionStats`: Duration per stage, CPU/GPU availability, memory footprint.
- `environment`: OS, Python version, CUDA/cuDNN metadata when relevant.

DLN-043b will consume these values to parameterize the .NET comparator and replicate reference options.

## Test case catalog

| Case ID | Input | Document traits | Primary assertions |
| --- | --- | --- | --- |
| `DLN043A-001` | `dataset/2305.03393v1-pg9-img.png` | Single scientific page exported as an image with dense math, tables, and inline figures. | Validates preprocessing DPI normalization, layout polygons for mixed content, EasyOCR ligature handling, and Markdown math formatting. |
| `DLN043A-002` | `dataset/amt_handbook_sample.pdf` | Multi-page PDF with tables, bullet lists, and headings. | Confirms consistent page-to-page normalization, TableFormer cell spans, and heading/paragraph grouping in Markdown. |
| `DLN043A-003` | `dataset/forms/irs-1040-2023.pdf` (to be added) | Form-style PDF with multi-column layout, checkboxes, and empty fields. | Stresses layout detection for tight boxes, placeholder text rendering, and figure crop deduplication. |
| `DLN043A-004` | `dataset/magazine/multilingual-spread.pdf` (to be added) | Magazine spread combining Latin and CJK text, rotated captions, and high-resolution imagery. | Exercises multilingual OCR fallback, rotated bounding boxes, and figure caption numbering in Markdown. |
| `DLN043A-005` | `dataset/tables/financial-report.xlsx.pdf` (to be added) | Table-dense document with merged cells and nested headers. | Validates TableFormer header inference, per-cell OCR re-entry, and Markdown table rendering with column alignment. |
| `DLN043A-006` | `dataset/scans/low-contrast-letter.pdf` (to be added) | Low-contrast scanned letter with skew and noise. | Evaluates preprocessing filters (deskew, binarize) and OCR confidence thresholds. |
| `DLN043A-007` | `dataset/handwritten/notebook-page.png` (to be added) | Handwritten notes with diagrams and inline annotations. | Gauges fallback behaviour when OCR confidence drops and ensures figures without text are exported correctly. |

The catalog intentionally keeps the initial two fixtures inside the repository (already under `dataset/`). Additional fixtures marked "to be added" will be introduced alongside their source files and licensing notes before the first golden refresh.

## Golden generation workflow

1. **Prepare Python environment**: checkout the reference Docling Python repository at the tagged release selected for parity (initially `v0.12.0`). Install dependencies and confirm the CLI produces deterministic output on the selected fixtures.
2. **Invoke CLI for each case**:
   ```bash
   docling --input <source> --output <case-dir>/python-cli --assets assets --telemetry telemetry.json \
     --markdown docling.md --manifest manifest.json --keep-debug-overlays
   ```
   The command stores Markdown and assets inside the golden bundle. Telemetry is captured via the `--telemetry` hook.
3. **Normalize paths**: strip absolute directories from manifests, enforce forward slashes, and map asset references to relative paths. DLN-043b will reuse the same normalizer for .NET outputs.
4. **Record provenance**: update `<case-id>/source/notes.md` with acquisition details, license terms, and manual annotations (e.g., "page 3 intentionally contains rotated caption").
5. **Commit goldens**: add the new bundle under `dataset/golden/<version>/`. Include `manifest.json` and `telemetry.json`; large binary assets stay under Git LFS if they exceed repository thresholds.

## Versioning & refresh policy

- **Version directory**: Goldens are grouped by semantic version matching the Python CLI tag (e.g., `dataset/golden/v0.12.0/`). Subsequent updates that rely on the same CLI version increment a patch suffix (`v0.12.0-1`) to distinguish maintenance refreshes (e.g., regenerated due to dataset corrections).
- **Refresh triggers**:
  - Upgrading Python CLI or ML models.
  - Adjusting pipeline options affecting output layout (DPI changes, new preprocessors).
  - Fixing corrupted or outdated source inputs.
  - Addressing parity gaps discovered by DLN-043c that require manual annotation adjustments.
- **Approval checklist** before updating an existing case:
  1. Document rationale in `notes.md`.
  2. Recompute `manifest.json` and ensure schema compatibility with .NET comparator.
  3. Run `.NET` parity tests locally (DLN-043c) to verify regression reports are clean.
  4. Increment the version folder or introduce a new case ID if the document semantics changed materially.

## Deliverables for DLN-043a

- Golden directory layout definition, manifest schema, and telemetry payload captured above.
- Initial catalog containing seven document archetypes with explicit source mapping and assertion focus.
- Versioning and refresh policy establishing deterministic reproduction of Python outputs.

Subsequent tasks (DLN-043b to DLN-043d) will build on this catalog to implement extraction, comparison, and CI automation.
